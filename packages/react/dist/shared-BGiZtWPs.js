"use strict";const j=require("react"),b=require("./shared-CVy2Ouqp.js"),M=require("./shared-I8hFcrmp.js"),d=require("livekit-client");function we(e){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const n in e)if(n!=="default"){const s=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,s.get?s:{enumerable:!0,get:()=>e[n]})}}return t.default=e,Object.freeze(t)}const r=we(j),ee=r.createContext(void 0);function Re(){const e=r.useContext(ee);if(!e)throw Error("tried to access session context outside of SessionProvider component");return e}function te(){return r.useContext(ee)}function pe(e){const t=te(),n=e??t;if(!n)throw new Error("No session provided, make sure you are inside a Session context or pass the session explicitly");return n}function Me(e){const t=b.useEnsureRoom(e),n=r.useCallback(async()=>{await t.startAudio()},[t]),s=r.useMemo(()=>b.roomAudioPlaybackAllowedObservable(t),[t]),{canPlayAudio:f}=M.useObservableState(s,{canPlayAudio:t.canPlaybackAudio});return{canPlayAudio:f,startAudio:n}}function Ae(e){const{state:t,dispatch:n}=M.useLayoutContext().pin;return{buttonProps:r.useMemo(()=>{const{className:f}=b.setupClearPinButton();return M.mergeProps(e,{className:f,disabled:!(t!=null&&t.length),onClick:()=>{n&&n({msg:"clear_pin"})}})},[e,n,t])}}function Le(e,t){const n=typeof e=="function"?e:t,s=typeof e=="string"?e:void 0,f=b.useRoomContext(),{send:c,messageObservable:o,isSendingObservable:p}=r.useMemo(()=>b.setupDataMessageHandler(f,s,n),[f,s,n]),T=M.useObservableState(o,void 0),E=M.useObservableState(p,!1);return{message:T,send:c,isSending:E}}const Oe={connect:!0,audio:!1,video:!1};function xe(e){const{token:t,serverUrl:n,options:s,room:f,connectOptions:c,connect:o,audio:p,video:T,screen:E,onConnected:v,onDisconnected:m,onError:u,onMediaDeviceFailure:k,onEncryptionError:R,simulateParticipants:x,...L}={...Oe,...e};s&&f&&b.log.warn("when using a manually created room, the options object will be ignored. set the desired options directly when creating the room instead.");const[A,I]=r.useState(),D=r.useRef(o);r.useEffect(()=>{I(f??new d.Room(s))},[f,JSON.stringify(s,M.roomOptionsStringifyReplacer)]);const a=r.useMemo(()=>{const{className:i}=b.setupLiveKitRoom();return M.mergeProps(L,{className:i})},[L]);return r.useEffect(()=>{if(!A)return;const i=()=>{const C=A.localParticipant;b.log.debug("trying to publish local tracks"),Promise.all([C.setMicrophoneEnabled(!!p,typeof p!="boolean"?p:void 0),C.setCameraEnabled(!!T,typeof T!="boolean"?T:void 0),C.setScreenShareEnabled(!!E,typeof E!="boolean"?E:void 0)]).catch(P=>{b.log.warn(P),u==null||u(P)})},l=(C,P)=>{const N=d.MediaDeviceFailure.getFailure(C);k==null||k(N,P)},h=C=>{R==null||R(C)},S=C=>{m==null||m(C)},y=()=>{v==null||v()};return A.on(d.RoomEvent.SignalConnected,i).on(d.RoomEvent.MediaDevicesError,l).on(d.RoomEvent.EncryptionError,h).on(d.RoomEvent.Disconnected,S).on(d.RoomEvent.Connected,y),()=>{A.off(d.RoomEvent.SignalConnected,i).off(d.RoomEvent.MediaDevicesError,l).off(d.RoomEvent.EncryptionError,h).off(d.RoomEvent.Disconnected,S).off(d.RoomEvent.Connected,y)}},[A,p,T,E,u,R,k,v,m]),r.useEffect(()=>{if(A){if(x){A.simulateParticipants({participants:{count:x},publish:{audio:!0,useRealTracks:!0}});return}if(o){if(D.current=!0,b.log.debug("connecting"),!t){b.log.debug("no token yet");return}if(!n){b.log.warn("no livekit url provided"),u==null||u(Error("no livekit url provided"));return}A.connect(n,t,c).catch(i=>{b.log.warn(i),D.current===!0&&(u==null||u(i))})}else b.log.debug("disconnecting because connect is false"),D.current=!1,A.disconnect()}},[o,t,JSON.stringify(c),A,u,n,x]),r.useEffect(()=>{if(A)return()=>{b.log.info("disconnecting on onmount"),A.disconnect()}},[A]),{room:A,htmlProps:a}}function he(e={}){let t=M.useMaybeParticipantContext();e.participant&&(t=e.participant);const n=r.useMemo(()=>b.participantInfoObserver(t),[t]),{identity:s,name:f,metadata:c}=M.useObservableState(n,{name:t==null?void 0:t.name,identity:t==null?void 0:t.identity,metadata:t==null?void 0:t.metadata});return{identity:s,name:f,metadata:c}}function De(e={}){const t=M.useEnsureParticipant(e.participant),n=r.useMemo(()=>b.participantPermissionObserver(t),[t]);return M.useObservableState(n,t.permissions)}function Z(e={}){const t=b.useEnsureRoom(e.room),[n,s]=r.useState([]);return r.useEffect(()=>{const f=b.connectedParticipantsObserver(t,{additionalRoomEvents:e.updateOnlyOn}).subscribe(s);return()=>f.unsubscribe()},[t,JSON.stringify(e.updateOnlyOn)]),n}function ve(e={}){const t=Z(e),{localParticipant:n}=b.useLocalParticipant(e);return r.useMemo(()=>[n,...t],[n,t])}function Ne(e,t={}){const n=b.useRoomContext(),[s]=r.useState(t.updateOnlyOn),f=r.useMemo(()=>typeof e=="string"?b.connectedParticipantObserver(n,e,{additionalEvents:s}):b.participantByIdentifierObserver(n,e,{additionalEvents:s}),[n,JSON.stringify(e),s]),[c,o]=r.useState({p:void 0});return r.useEffect(()=>{const p=f.subscribe(T=>o({p:T}));return()=>p.unsubscribe()},[f]),c.p}function _e(e={}){const t=b.useEnsureRoom(e.room),n=r.useMemo(()=>b.roomInfoObserver(t),[t]),{name:s,metadata:f}=M.useObservableState(n,{name:t.name,metadata:t.metadata});return{name:s,metadata:f}}function be(e){const t=b.useEnsureRoom(e==null?void 0:e.room),n=r.useMemo(()=>b.activeSpeakerObserver(t),[t]);return M.useObservableState(n,t.activeSpeakers)}function Ie(e){const[t,n]=r.useState(b.sortParticipants(e)),s=be();return r.useEffect(()=>{n(b.sortParticipants(e))},[s,e]),t}function Fe(e,t,n={}){const[s,f]=r.useState(void 0);return r.useEffect(()=>{var o;if(e===void 0)throw Error("token endpoint needs to be defined");if(((o=n.userInfo)==null?void 0:o.identity)===void 0)return;(async()=>{b.log.debug("fetching token");const p=new URLSearchParams({...n.userInfo,roomName:t}),T=await fetch(`${e}?${p.toString()}`);if(!T.ok){b.log.error(`Could not fetch token. Server responded with status ${T.status}: ${T.statusText}`);return}const{accessToken:E}=await T.json();f(E)})()},[e,t,JSON.stringify(n)]),s}function Ue(e){const[t,n]=r.useState(b.getTrackByIdentifier(e)),{trackObserver:s}=r.useMemo(()=>b.setupMediaTrack(e),[e.participant.sid??e.participant.identity,e.source]);return r.useEffect(()=>{const f=s.subscribe(c=>{n(c)});return()=>f==null?void 0:f.unsubscribe()},[s]),{participant:e.participant,source:e.source??d.Track.Source.Unknown,publication:t}}function je(e,t){const n=M.useEnsureParticipant(t);return Ue({name:e,participant:n})}function Q(e,t={}){let n,s;typeof t=="string"?n=t:(n=t==null?void 0:t.participantIdentity,s=t==null?void 0:t.room);const f=M.useMaybeParticipantContext(),c=ve({room:s,updateOnlyOn:[]}),o=r.useMemo(()=>n?c.find(E=>E.identity===n):f,[n,c,f]),p=r.useMemo(()=>{if(o)return b.participantTracksObservable(o,{sources:e})},[o,JSON.stringify(e)]);return M.useObservableState(p,[])}function He(e){var n,s,f;const t=r.useMemo(()=>{var c;return(c=e==null?void 0:e.publication)!=null&&c.track?b.trackSyncTimeObserver(e==null?void 0:e.publication.track):void 0},[(n=e==null?void 0:e.publication)==null?void 0:n.track]);return M.useObservableState(t,{timestamp:Date.now(),rtpTimestamp:(f=(s=e==null?void 0:e.publication)==null?void 0:s.track)==null?void 0:f.rtpTimestamp})}const Be={bufferSize:100};function ge(e,t){const n={...Be,...t},[s,f]=r.useState([]),c=He(e),o=p=>{var T;(T=n.onTranscription)==null||T.call(n,p),f(E=>b.dedupeSegments(E,p.map(v=>b.addMediaTimestampToTranscription(v,c)),n.bufferSize))};return r.useEffect(()=>{if(!(e!=null&&e.publication))return;const p=b.trackTranscriptionObserver(e.publication).subscribe(T=>{o(...T)});return()=>{p.unsubscribe()}},[e&&b.getTrackReferenceId(e),o]),{segments:s}}function Se(e={}){const t=M.useMaybeParticipantContext(),n=e.participant??t,s=r.useMemo(()=>b.participantAttributesObserver(n),[n]);return M.useObservableState(s,{attributes:n==null?void 0:n.attributes})}function We(e,t={}){const n=M.useEnsureParticipant(t.participant),[s,f]=r.useState(n.attributes[e]);return r.useEffect(()=>{if(!n)return;const c=b.participantAttributesObserver(n).subscribe(o=>{o.changed[e]!==void 0&&f(o.attributes[e])});return()=>{c.unsubscribe()}},[n,e]),s}const ce=b.ParticipantAgentAttributes.AgentState;function qe(){const e=Z(),t=e.find(m=>m.kind===d.ParticipantKind.AGENT&&!(b.ParticipantAgentAttributes.PublishOnBehalf in m.attributes)),n=e.find(m=>m.kind===d.ParticipantKind.AGENT&&m.attributes[b.ParticipantAgentAttributes.PublishOnBehalf]===(t==null?void 0:t.identity)),s=Q([d.Track.Source.Microphone,d.Track.Source.Camera],t==null?void 0:t.identity),f=Q([d.Track.Source.Microphone,d.Track.Source.Camera],n==null?void 0:n.identity),c=s.find(m=>m.source===d.Track.Source.Microphone)??f.find(m=>m.source===d.Track.Source.Microphone),o=s.find(m=>m.source===d.Track.Source.Camera)??f.find(m=>m.source===d.Track.Source.Camera),{segments:p}=ge(c),T=M.useConnectionState(),{attributes:E}=Se({participant:t}),v=r.useMemo(()=>T===d.ConnectionState.Disconnected?"disconnected":T===d.ConnectionState.Connecting||!t||!(E!=null&&E[ce])?"connecting":E[ce],[E,t,T]);return{agent:t,state:v,audioTrack:c,videoTrack:o,agentTranscriptions:p,agentAttributes:E}}function Ge(e){const t=b.useEnsureRoom(e),n=M.useConnectionState(t),s=r.useMemo(()=>b.recordingStatusObservable(t),[t,n]);return M.useObservableState(s,t.isRecording)}function Ce(e,t){const n=b.useEnsureRoom(t==null?void 0:t.room),f=M.useConnectionState(n)===d.ConnectionState.Disconnected,c=r.useMemo(()=>b.setupTextStream(n,e),[n,e]),o=f?void 0:c;return{textStreams:M.useObservableState(o,[])}}function Te(e){const{participantIdentities:t,trackSids:n}=e??{},{textStreams:s}=Ce(b.DataTopic.TRANSCRIPTION,{room:e==null?void 0:e.room});return r.useMemo(()=>s.filter(c=>t?t.includes(c.participantInfo.identity):!0).filter(c=>{var o;return n?n.includes(((o=c.streamInfo.attributes)==null?void 0:o[b.ParticipantAgentAttributes.TranscribedTrackId])??""):!0}),[s,t,n])}const ue=2,de=400,le=3,fe=1e3;function Ke(e){const t=j.useRef([]),n=j.useMemo(()=>new d.Mutex,[]),s=j.useCallback(async()=>n.lock().then(async v=>{for(;;){const m=t.current.pop();if(!m){v();break}switch(m.type){case"connect":await m.room.connect(...m.args).then(m.resolve).catch(m.reject);break;case"disconnect":await m.room.disconnect(...m.args).then(m.resolve).catch(m.reject);break}}}),[]),f=j.useRef([]),c=j.useCallback(v=>{let m=0;f.current=f.current.filter(u=>{const k=v.getTime()-u.getTime()<fe;return k&&(m+=1),k}),m>le&&b.log.warn(`useSequentialRoomConnectDisconnect: room changed reference rapidly (over ${le}x in ${fe}ms). This is not recommended.`)},[]);j.useEffect(()=>{t.current=[];const v=new Date;f.current.push(v),c(v)},[e,c]);const o=j.useRef([]),p=j.useCallback(v=>{let m=0;o.current=o.current.filter(u=>{const k=v.getTime()-u.getTime()<de;return k&&(m+=1),k}),m>ue&&b.log.warn(`useSequentialRoomConnectDisconnect: room connect / disconnect occurring in rapid sequence (over ${ue}x in ${de}ms). This is not recommended and may be the sign of a bug like a useEffect dependency changing every render.`)},[]),T=j.useCallback(async(...v)=>new Promise((m,u)=>{if(!e)throw new Error("Called connect(), but room was unset");const k=new Date;p(k),t.current.push({type:"connect",room:e,args:v,resolve:m,reject:u}),o.current.push(k),s()}),[e,p,s]),E=j.useCallback(async(...v)=>new Promise((m,u)=>{if(!e)throw new Error("Called discconnect(), but room was unset");const k=new Date;p(k),t.current.push({type:"disconnect",room:e,args:v,resolve:m,reject:u}),o.current.push(k),s()}),[e,p,s]);return{connect:e?T:null,disconnect:e?E:null}}var X={exports:{}},me;function $e(){if(me)return X.exports;me=1;var e=typeof Reflect=="object"?Reflect:null,t=e&&typeof e.apply=="function"?e.apply:function(i,l,h){return Function.prototype.apply.call(i,l,h)},n;e&&typeof e.ownKeys=="function"?n=e.ownKeys:Object.getOwnPropertySymbols?n=function(i){return Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i))}:n=function(i){return Object.getOwnPropertyNames(i)};function s(a){console&&console.warn&&console.warn(a)}var f=Number.isNaN||function(i){return i!==i};function c(){c.init.call(this)}X.exports=c,X.exports.once=A,c.EventEmitter=c,c.prototype._events=void 0,c.prototype._eventsCount=0,c.prototype._maxListeners=void 0;var o=10;function p(a){if(typeof a!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof a)}Object.defineProperty(c,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(a){if(typeof a!="number"||a<0||f(a))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+a+".");o=a}}),c.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},c.prototype.setMaxListeners=function(i){if(typeof i!="number"||i<0||f(i))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+i+".");return this._maxListeners=i,this};function T(a){return a._maxListeners===void 0?c.defaultMaxListeners:a._maxListeners}c.prototype.getMaxListeners=function(){return T(this)},c.prototype.emit=function(i){for(var l=[],h=1;h<arguments.length;h++)l.push(arguments[h]);var S=i==="error",y=this._events;if(y!==void 0)S=S&&y.error===void 0;else if(!S)return!1;if(S){var C;if(l.length>0&&(C=l[0]),C instanceof Error)throw C;var P=new Error("Unhandled error."+(C?" ("+C.message+")":""));throw P.context=C,P}var N=y[i];if(N===void 0)return!1;if(typeof N=="function")t(N,this,l);else for(var H=N.length,U=R(N,H),h=0;h<H;++h)t(U[h],this,l);return!0};function E(a,i,l,h){var S,y,C;if(p(l),y=a._events,y===void 0?(y=a._events=Object.create(null),a._eventsCount=0):(y.newListener!==void 0&&(a.emit("newListener",i,l.listener?l.listener:l),y=a._events),C=y[i]),C===void 0)C=y[i]=l,++a._eventsCount;else if(typeof C=="function"?C=y[i]=h?[l,C]:[C,l]:h?C.unshift(l):C.push(l),S=T(a),S>0&&C.length>S&&!C.warned){C.warned=!0;var P=new Error("Possible EventEmitter memory leak detected. "+C.length+" "+String(i)+" listeners added. Use emitter.setMaxListeners() to increase limit");P.name="MaxListenersExceededWarning",P.emitter=a,P.type=i,P.count=C.length,s(P)}return a}c.prototype.addListener=function(i,l){return E(this,i,l,!1)},c.prototype.on=c.prototype.addListener,c.prototype.prependListener=function(i,l){return E(this,i,l,!0)};function v(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function m(a,i,l){var h={fired:!1,wrapFn:void 0,target:a,type:i,listener:l},S=v.bind(h);return S.listener=l,h.wrapFn=S,S}c.prototype.once=function(i,l){return p(l),this.on(i,m(this,i,l)),this},c.prototype.prependOnceListener=function(i,l){return p(l),this.prependListener(i,m(this,i,l)),this},c.prototype.removeListener=function(i,l){var h,S,y,C,P;if(p(l),S=this._events,S===void 0)return this;if(h=S[i],h===void 0)return this;if(h===l||h.listener===l)--this._eventsCount===0?this._events=Object.create(null):(delete S[i],S.removeListener&&this.emit("removeListener",i,h.listener||l));else if(typeof h!="function"){for(y=-1,C=h.length-1;C>=0;C--)if(h[C]===l||h[C].listener===l){P=h[C].listener,y=C;break}if(y<0)return this;y===0?h.shift():x(h,y),h.length===1&&(S[i]=h[0]),S.removeListener!==void 0&&this.emit("removeListener",i,P||l)}return this},c.prototype.off=c.prototype.removeListener,c.prototype.removeAllListeners=function(i){var l,h,S;if(h=this._events,h===void 0)return this;if(h.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):h[i]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete h[i]),this;if(arguments.length===0){var y=Object.keys(h),C;for(S=0;S<y.length;++S)C=y[S],C!=="removeListener"&&this.removeAllListeners(C);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(l=h[i],typeof l=="function")this.removeListener(i,l);else if(l!==void 0)for(S=l.length-1;S>=0;S--)this.removeListener(i,l[S]);return this};function u(a,i,l){var h=a._events;if(h===void 0)return[];var S=h[i];return S===void 0?[]:typeof S=="function"?l?[S.listener||S]:[S]:l?L(S):R(S,S.length)}c.prototype.listeners=function(i){return u(this,i,!0)},c.prototype.rawListeners=function(i){return u(this,i,!1)},c.listenerCount=function(a,i){return typeof a.listenerCount=="function"?a.listenerCount(i):k.call(a,i)},c.prototype.listenerCount=k;function k(a){var i=this._events;if(i!==void 0){var l=i[a];if(typeof l=="function")return 1;if(l!==void 0)return l.length}return 0}c.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]};function R(a,i){for(var l=new Array(i),h=0;h<i;++h)l[h]=a[h];return l}function x(a,i){for(;i+1<a.length;i++)a[i]=a[i+1];a.pop()}function L(a){for(var i=new Array(a.length),l=0;l<i.length;++l)i[l]=a[l].listener||a[l];return i}function A(a,i){return new Promise(function(l,h){function S(C){a.removeListener(i,y),h(C)}function y(){typeof a.removeListener=="function"&&a.removeListener("error",S),l([].slice.call(arguments))}D(a,i,y,{once:!0}),i!=="error"&&I(a,S,{once:!0})})}function I(a,i,l){typeof a.on=="function"&&D(a,"error",i,l)}function D(a,i,l,h){if(typeof a.on=="function")h.once?a.once(i,l):a.on(i,l);else if(typeof a.addEventListener=="function")a.addEventListener(i,function S(y){h.once&&a.removeEventListener(i,S),l(y)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof a)}return X.exports}var ne=$e();const ze=2e4;var Ee=(e=>(e.CameraChanged="cameraChanged",e.MicrophoneChanged="microphoneChanged",e.StateChanged="stateChanged",e))(Ee||{});const F=e=>({isConnected:e==="listening"||e==="thinking"||e==="speaking",canListen:e==="pre-connect-buffering"||e==="listening"||e==="thinking"||e==="speaking",isFinished:e==="disconnected"||e==="failed",isPending:e==="connecting"||e==="initializing"||e==="idle"}),Je=()=>{const[e,t]=r.useState(null),[n,s]=r.useState(null),f=r.useRef("connecting"),c=r.useRef(!1),o=p=>setTimeout(()=>{if(!c.current){t("Agent did not join the room.");return}const{isConnected:T}=F(f.current);if(!T){t("Agent joined the room but did not complete initializing.");return}},p??ze);return{agentTimeoutFailureReason:e,startAgentTimeout:r.useCallback(p=>{n&&clearTimeout(n),t(null),s(o(p)),f.current="connecting",c.current=!1},[n]),clearAgentTimeout:r.useCallback(()=>{n&&clearTimeout(n),t(null),s(null),f.current="connecting",c.current=!1},[n]),clearAgentTimeoutFailureReason:r.useCallback(()=>{t(null)},[]),updateAgentTimeoutState:r.useCallback(p=>{f.current=p},[]),updateAgentTimeoutParticipantExists:r.useCallback(p=>{c.current=p},[])}};function Ve(e,t){const n=r.useRef(t);r.useEffect(()=>{n.current=t},[t]);const s=r.useCallback(async o=>{const{isConnected:p}=F(n.current);if(!p)return new Promise((T,E)=>{const v=k=>{const{isConnected:R}=F(k);R&&(u(),T())},m=()=>{u(),E(new Error("useAgent(/* ... */).waitUntilConnected - signal aborted"))},u=()=>{e.off("stateChanged",v),o==null||o.removeEventListener("abort",m)};e.on("stateChanged",v),o==null||o.addEventListener("abort",m)})},[e]),f=r.useCallback(async o=>{const{canListen:p}=F(n.current);if(!p)return new Promise((T,E)=>{const v=k=>{const{canListen:R}=F(k);R&&(u(),T())},m=()=>{u(),E(new Error("useAgent(/* ... */).waitUntilCouldBeListening - signal aborted"))},u=()=>{e.off("stateChanged",v),o==null||o.removeEventListener("abort",m)};e.on("stateChanged",v),o==null||o.addEventListener("abort",m)})},[e]),c=r.useCallback(async o=>{const{isFinished:p}=F(n.current);if(!p)return new Promise((T,E)=>{const v=k=>{const{isFinished:R}=F(k);R&&(u(),T())},m=()=>{u(),E(new Error("useAgent(/* ... */).waitUntilFinished - signal aborted"))},u=()=>{e.off("stateChanged",v),o==null||o.removeEventListener("abort",m)};e.on("stateChanged",v),o==null||o.addEventListener("abort",m)})},[e]);return{waitUntilConnected:s,waitUntilCouldBeListening:f,waitUntilFinished:c}}function re(e){const t=te();if(e=e??t,!e)throw new Error("No session provided, make sure you are inside a Session context or pass the session explicitly");const{room:n,internal:{agentConnectTimeoutMilliseconds:s,agentTimeoutFailureReason:f,startAgentTimeout:c,clearAgentTimeout:o,clearAgentTimeoutFailureReason:p,updateAgentTimeoutState:T,updateAgentTimeoutParticipantExists:E}}=e,v=r.useMemo(()=>new ne.EventEmitter,[]),m=Z({room:n}),u=r.useMemo(()=>m.find(g=>g.kind===d.ParticipantKind.AGENT&&!(b.ParticipantAgentAttributes.PublishOnBehalf in g.attributes))??null,[m]),k=r.useMemo(()=>u?m.find(g=>g.kind===d.ParticipantKind.AGENT&&g.attributes[b.ParticipantAgentAttributes.PublishOnBehalf]===u.identity)??null:null,[u,m]),[R,x]=r.useState((u==null?void 0:u.attributes)??{});r.useEffect(()=>{if(!u)return;const g=_=>{x(_)};return u.on(d.ParticipantEvent.AttributesChanged,g),()=>{u.off(d.ParticipantEvent.AttributesChanged,g)}},[u,v]);const L=Q([d.Track.Source.Camera,d.Track.Source.Microphone],{room:n,participantIdentity:u==null?void 0:u.identity}),A=Q([d.Track.Source.Camera,d.Track.Source.Microphone],{room:n,participantIdentity:k==null?void 0:k.identity}),I=r.useMemo(()=>L.find(g=>g.source===d.Track.Source.Camera)??A.find(g=>g.source===d.Track.Source.Camera),[L,A]);r.useEffect(()=>{v.emit("cameraChanged",I)},[v,I]);const D=r.useMemo(()=>L.find(g=>g.source===d.Track.Source.Microphone)??A.find(g=>g.source===d.Track.Source.Microphone),[L,A]);r.useEffect(()=>{v.emit("microphoneChanged",D)},[v,D]);const[a,i]=r.useState(n.state);r.useEffect(()=>{const g=_=>{i(_)};return n.on(d.RoomEvent.ConnectionStateChanged,g),()=>{n.off(d.RoomEvent.ConnectionStateChanged,g)}},[n]),r.useEffect(()=>{u&&p()},[u]);const[l,h]=r.useState(null);r.useEffect(()=>{if(!u)return;const g=_=>{_.identity===(u==null?void 0:u.identity)&&h("Agent left the room unexpectedly.")};return n.on(d.RoomEvent.ParticipantDisconnected,g),()=>{n.off(d.RoomEvent.ParticipantDisconnected,g)}},[u,n]),r.useEffect(()=>{a===d.ConnectionState.Disconnected&&h(null)},[a]);const[S,y]=r.useState(()=>n.localParticipant.getTrackPublication(d.Track.Source.Microphone)??null);r.useEffect(()=>{const g=()=>{y(n.localParticipant.getTrackPublication(d.Track.Source.Microphone)??null)},_=()=>{y(null)};return n.localParticipant.on(d.ParticipantEvent.LocalTrackPublished,g),n.localParticipant.on(d.ParticipantEvent.LocalTrackUnpublished,_),()=>{n.localParticipant.off(d.ParticipantEvent.LocalTrackPublished,g),n.localParticipant.off(d.ParticipantEvent.LocalTrackUnpublished,_)}},[n.localParticipant]);const C=r.useMemo(()=>{const g=[];return f&&g.push(f),l&&g.push(l),g},[f,l]),P=r.useMemo(()=>{if(C.length>0)return"failed";let g="disconnected";return a!==d.ConnectionState.Disconnected&&(g="connecting"),S&&(g="pre-connect-buffering"),u&&R[b.ParticipantAgentAttributes.AgentState]&&(g=R[b.ParticipantAgentAttributes.AgentState]),g},[C,a,S,u,R]);r.useEffect(()=>{v.emit("stateChanged",P),T(P)},[v,P]),r.useEffect(()=>{E(u!==null)},[u]);const N=e.connectionState==="disconnected";r.useEffect(()=>{if(!N)return c(s),()=>{o()}},[N,s]);const{identity:H,name:U,metadata:$}=he({participant:u??void 0}),V=r.useMemo(()=>{const g={attributes:R,internal:{agentParticipant:u,workerParticipant:k,emitter:v}};switch(P){case"disconnected":return{...g,identity:void 0,name:void 0,metadata:void 0,state:P,...F(P),failureReasons:null,cameraTrack:void 0,microphoneTrack:void 0};case"connecting":return{...g,identity:void 0,name:void 0,metadata:void 0,state:P,...F(P),failureReasons:null,cameraTrack:void 0,microphoneTrack:void 0};case"initializing":case"idle":return{...g,identity:H,name:U,metadata:$,state:P,...F(P),failureReasons:null,cameraTrack:I,microphoneTrack:D};case"pre-connect-buffering":return{...g,identity:H,name:U,metadata:$,state:P,...F(P),failureReasons:null,cameraTrack:I,microphoneTrack:D};case"listening":case"thinking":case"speaking":return{...g,identity:H,name:U,metadata:$,state:P,...F(P),failureReasons:null,cameraTrack:I,microphoneTrack:D};case"failed":return{...g,identity:void 0,name:void 0,metadata:void 0,state:"failed",...F("failed"),failureReasons:C,cameraTrack:void 0,microphoneTrack:void 0}}},[H,U,$,R,v,u,P,I,D]),{waitUntilConnected:z,waitUntilCouldBeListening:w,waitUntilFinished:O}=Ve(v,P),B=r.useCallback(g=>new Promise((_,J)=>{const W=K=>{K&&(G(),_(K))},q=()=>{G(),J(new Error("useAgent(/* ... */).waitUntilCamera - signal aborted"))},G=()=>{v.off("cameraChanged",W),g==null||g.removeEventListener("abort",q)};v.on("cameraChanged",W),g==null||g.addEventListener("abort",q)}),[v]),Y=r.useCallback(g=>new Promise((_,J)=>{const W=K=>{K&&(G(),_(K))},q=()=>{G(),J(new Error("useAgent(/* ... */).waitUntilMicrophone - signal aborted"))},G=()=>{v.off("microphoneChanged",W),g==null||g.removeEventListener("abort",q)};v.on("microphoneChanged",W),g==null||g.addEventListener("abort",q)}),[v]);return r.useMemo(()=>({...V,waitUntilConnected:z,waitUntilCouldBeListening:w,waitUntilFinished:O,waitUntilCamera:B,waitUntilMicrophone:Y}),[V,z,w,O,B,Y])}var ke=(e=>(e.ConnectionStateChanged="connectionStateChanged",e.MediaDevicesError="mediaDevicesError",e.EncryptionError="encryptionError",e))(ke||{});function Qe(e,t){const n=new Set([...Object.keys(e),...Object.keys(t)]);for(const s of n)switch(s){case"roomName":case"participantName":case"participantIdentity":case"participantMetadata":case"participantAttributes":case"agentName":case"agentMetadata":if(e[s]!==t[s])return!1;break;default:const f=s;throw new Error(`Options key ${f} not being checked for equality!`)}return!0}function Ye(e,t){const n=r.useRef(t);return r.useEffect(()=>{n.current=t},[t]),r.useCallback(async(f,c)=>{if(n.current!==f)return new Promise((o,p)=>{const T=m=>{m===f&&(v(),o())},E=()=>{v(),p(new Error(`useSession(/* ... */).waitUntilConnectionState(${f}, /* signal */) - signal aborted`))},v=()=>{e.off("connectionStateChanged",T),c==null||c.removeEventListener("abort",E)};e.on("connectionStateChanged",T),c==null||c.addEventListener("abort",E)})},[e])}function Xe(e,t){const n=e instanceof d.TokenSourceConfigurable,s=r.useRef(n?t:null);return r.useEffect(()=>{if(!n){s.current=null;return}s.current!==null&&Qe(s.current,t)||(s.current=t)},[n,t]),r.useCallback(async()=>{if(n){if(!s.current)throw new Error("AgentSession - memoized token fetch options are not set, but the passed tokenSource was an instance of TokenSourceConfigurable. If you are seeing this please make a new GitHub issue!");return e.fetch(s.current)}else return e.fetch()},[n,e])}function Ze(e,t={}){const{room:n,agentConnectTimeoutMilliseconds:s,...f}=t,c=b.useMaybeRoomContext(),o=r.useMemo(()=>c??n??new d.Room,[c,n]),p=r.useMemo(()=>new ne.EventEmitter,[]),T=r.useCallback(w=>({isConnected:w===d.ConnectionState.Connected||w===d.ConnectionState.Reconnecting||w===d.ConnectionState.SignalReconnecting}),[]),[E,v]=r.useState(o.state);r.useEffect(()=>{const w=O=>{v(O)};return o.on(d.RoomEvent.ConnectionStateChanged,w),()=>{o.off(d.RoomEvent.ConnectionStateChanged,w)}},[o]),r.useEffect(()=>{const w=async O=>{p.emit("mediaDevicesError",O)};return o.on(d.RoomEvent.MediaDevicesError,w),()=>{o.off(d.RoomEvent.MediaDevicesError,w)}},[o,p]),r.useEffect(()=>{const w=async O=>{p.emit("encryptionError",O)};return o.on(d.RoomEvent.EncryptionError,w),()=>{o.off(d.RoomEvent.EncryptionError,w)}},[o,p]);const{localParticipant:m}=b.useLocalParticipant({room:o}),u=m.getTrackPublication(d.Track.Source.Camera),k=r.useMemo(()=>{if(u)return{source:d.Track.Source.Camera,participant:m,publication:u}},[m,u]),R=m.getTrackPublication(d.Track.Source.Microphone),x=r.useMemo(()=>{if(R)return{source:d.Track.Source.Microphone,participant:m,publication:R}},[m,R]),L=m.getTrackPublication(d.Track.Source.ScreenShare),A=r.useMemo(()=>{if(L)return{source:d.Track.Source.ScreenShare,participant:m,publication:L}},[m,L]),{agentTimeoutFailureReason:I,startAgentTimeout:D,clearAgentTimeout:a,clearAgentTimeoutFailureReason:i,updateAgentTimeoutState:l,updateAgentTimeoutParticipantExists:h}=Je(),S=r.useMemo(()=>({emitter:p,tokenSource:e,agentConnectTimeoutMilliseconds:s,agentTimeoutFailureReason:I,startAgentTimeout:D,clearAgentTimeout:a,clearAgentTimeoutFailureReason:i,updateAgentTimeoutState:l,updateAgentTimeoutParticipantExists:h}),[p,s,e,I,D,a,i,l,h]),y=r.useMemo(()=>{const w={room:o,internal:S};switch(E){case d.ConnectionState.Connecting:return{...w,connectionState:d.ConnectionState.Connecting,...T(d.ConnectionState.Connecting),local:{cameraTrack:void 0,microphoneTrack:void 0,screenShareTrack:void 0}};case d.ConnectionState.Connected:case d.ConnectionState.Reconnecting:case d.ConnectionState.SignalReconnecting:return{...w,connectionState:E,...T(E),local:{cameraTrack:k,microphoneTrack:x,screenShareTrack:A}};case d.ConnectionState.Disconnected:return{...w,connectionState:d.ConnectionState.Disconnected,...T(d.ConnectionState.Disconnected),local:{cameraTrack:void 0,microphoneTrack:void 0,screenShareTrack:void 0}}}},[S,o,E,k,x,T]);r.useEffect(()=>{p.emit("connectionStateChanged",y.connectionState)},[p,y.connectionState]);const C=Ye(p,y.connectionState),P=r.useCallback(async w=>C(d.ConnectionState.Connected,w),[C]),N=r.useCallback(async w=>C(d.ConnectionState.Disconnected,w),[C]),H=re(r.useMemo(()=>({connectionState:y.connectionState,room:o,internal:S}),[y,o,S])),U=Xe(e,f),$=r.useCallback(async(w={})=>{var J,W,q,G,K,oe;const{signal:O,tracks:B={microphone:{enabled:!0,publishOptions:{preConnectBuffer:!0}}},roomConnectOptions:Y}=w;await N(O);const g=()=>{o.disconnect()};O==null||O.addEventListener("abort",g);let _=!1;await Promise.all([U().then(({serverUrl:Pe,participantToken:ie})=>{var se,ae;return _=(((ae=(se=d.decodeTokenPayload(ie).roomConfig)==null?void 0:se.agents)==null?void 0:ae.length)??0)>0,o.connect(Pe,ie,Y)}),(J=B.microphone)!=null&&J.enabled?o.localParticipant.setMicrophoneEnabled(!0,void 0,((W=B.microphone)==null?void 0:W.publishOptions)??{}):Promise.resolve(),(q=B.camera)!=null&&q.enabled?o.localParticipant.setCameraEnabled(!0,void 0,((G=B.camera)==null?void 0:G.publishOptions)??{}):Promise.resolve(),(K=B.screenShare)!=null&&K.enabled?o.localParticipant.setScreenShareEnabled(!0,void 0,((oe=B.screenShare)==null?void 0:oe.publishOptions)??{}):Promise.resolve()]),await P(O),_&&await H.waitUntilConnected(O),O==null||O.removeEventListener("abort",g)},[o,N,U,P,H.waitUntilConnected]),V=r.useCallback(async()=>{await o.disconnect()},[o]),z=r.useCallback(async()=>{const w=await U();await o.prepareConnection(w.serverUrl,w.participantToken)},[U,o]);return r.useEffect(()=>{z().catch(w=>{console.warn("WARNING: Room.prepareConnection failed:",w)})},[]),r.useMemo(()=>({...y,waitUntilConnected:P,waitUntilDisconnected:N,prepareConnection:z,start:$,end:V}),[y,P,N,z,$,V])}function et(e,t,n,s){const f=r.useMemo(()=>()=>{},[]),c=r.useCallback(n??f,s??[]),o=s?c:n,p=r.useMemo(()=>e?"internal"in e?e.internal.emitter:e:null,[e]);r.useEffect(()=>{if(!(!p||!o))return p.on(t,o),()=>{p.off(t,o)}},[p,t,o])}var ye=(e=>(e.MessageReceived="messageReceived",e))(ye||{});function tt(e){const{room:t}=pe(e),n=r.useMemo(()=>new ne.EventEmitter,[]),s=re(e),f=Te({room:t}),c=r.useMemo(()=>({room:t}),[t]),o=M.useChat(c),p=r.useMemo(()=>f.map(u=>{var k,R,x;switch(u.participantInfo.identity){case t.localParticipant.identity:return{type:"userTranscript",message:u.text,id:u.streamInfo.id,timestamp:u.streamInfo.timestamp,from:t.localParticipant};case((k=s.internal.agentParticipant)==null?void 0:k.identity):case((R=s.internal.workerParticipant)==null?void 0:R.identity):return{type:"agentTranscript",message:u.text,id:u.streamInfo.id,timestamp:u.streamInfo.timestamp,from:((x=s.internal.agentParticipant)==null?void 0:x.identity)===u.participantInfo.identity?s.internal.agentParticipant:s.internal.workerParticipant};default:return{type:"agentTranscript",message:u.text,id:u.streamInfo.id,timestamp:u.streamInfo.timestamp,from:Array.from(t.remoteParticipants.values()).find(L=>L.identity===u.participantInfo.identity)}}}),[f,t]),T=r.useMemo(()=>[...p,...o.chatMessages],[p,o.chatMessages]),E=r.useRef(new Map),v=r.useMemo(()=>{const u=new Date;for(const k of T)E.current.has(k.id)||E.current.set(k.id,u);return T.sort((k,R)=>{const x=E.current.get(k.id),L=E.current.get(R.id);return typeof x>"u"||typeof L>"u"?0:x.getTime()-L.getTime()})},[T]),m=r.useRef(new Set);return r.useEffect(()=>{for(const u of v)m.current.has(u.id)||(m.current.add(u.id),n.emit("messageReceived",u))},[v]),r.useMemo(()=>({messages:v,send:o.send,isSending:o.isSending,internal:{emitter:n}}),[v,o.send,o.isSending])}exports.AgentEvent=Ee;exports.MessagesEvent=ye;exports.SessionContext=ee;exports.SessionEvent=ke;exports.useAgent=re;exports.useAudioPlayback=Me;exports.useClearPinButton=Ae;exports.useDataChannel=Le;exports.useEnsureSession=pe;exports.useEvents=et;exports.useIsRecording=Ge;exports.useLiveKitRoom=xe;exports.useMaybeSessionContext=te;exports.useParticipantAttribute=We;exports.useParticipantAttributes=Se;exports.useParticipantInfo=he;exports.useParticipantPermissions=De;exports.useParticipantTracks=Q;exports.useParticipants=ve;exports.useRemoteParticipant=Ne;exports.useRemoteParticipants=Z;exports.useRoomInfo=_e;exports.useSequentialRoomConnectDisconnect=Ke;exports.useSession=Ze;exports.useSessionContext=Re;exports.useSessionMessages=tt;exports.useSortedParticipants=Ie;exports.useSpeakingParticipants=be;exports.useTextStream=Ce;exports.useToken=Fe;exports.useTrackByName=je;exports.useTrackTranscription=ge;exports.useTranscriptions=Te;exports.useVoiceAssistant=qe;
//# sourceMappingURL=shared-BGiZtWPs.js.map
